---
- name: Check MySQL Database Space and Health
  hosts: all
  become: true
  vars:
    mysql_user: "mysqlAutomation"
    mysql_password: "mysqlAutomation"
    mysql_host: "127.0.0.1"

  tasks:

    - name: Ensure MySQL client is installed
      package:
        name: mysql-client  # For Debian/Ubuntu; use 'mysql' for RHEL/CentOS
        state: present

    - name: Get database space usage via MySQL command
      shell: |
        mysql -u"{{ mysql_user }}" -p"{{ mysql_password }}" -h"{{ mysql_host }}" -e \
        "SELECT table_schema AS 'Database', 
                ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' 
         FROM information_schema.tables 
         GROUP BY table_schema;"
      register: db_space_output
      no_log: true  # Hides sensitive information from logs

    - name: Show database sizes
      debug:
        msg: "{{ db_space_output.stdout_lines }}"

    - name: Check MySQL server health (Threads Connected)
      shell: |
        mysql -u"{{ mysql_user }}" -p"{{ mysql_password }}" -h"{{ mysql_host }}" -e \
        "SHOW GLOBAL STATUS LIKE 'Threads_connected';"
      register: db_health_status
      changed_when: false
      no_log: true

    - name: Show MySQL server health status
      debug:
        msg: "MySQL Health Status: {{ db_health_status.stdout_lines }}"

    - name: Check for deadlocks in MySQL InnoDB engine
      shell: |
        mysql -u"{{ mysql_user }}" -p"{{ mysql_password }}" -h"{{ mysql_host }}" -e \
        "SHOW ENGINE INNODB STATUS\G"
      register: innodb_status
      changed_when: false
      no_log: true

    - name: Show InnoDB status for deadlocks
      debug:
        msg: "InnoDB Status (Deadlocks): {{ innodb_status.stdout_lines }}"

    - name: Check for running MySQL jobs/events
      shell: |
        mysql -u"{{ mysql_user }}" -p"{{ mysql_password }}" -h"{{ mysql_host }}" -e \
        "SHOW PROCESSLIST;"
      register: job_activity
      changed_when: false
      no_log: true

    - name: Show running job activities in MySQL
      debug:
        msg: "Current MySQL job activities: {{ job_activity.stdout_lines }}"
